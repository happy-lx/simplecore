### PTW的虚拟地址转化为物理地址算法

![2020-11-15 13-11-47 的屏幕截图](/home/lx/图片/2020-11-15 13-11-47 的屏幕截图.png)

+ sv39是三级页表结构，首先需要从`sapt`csr寄存器中得到root页表的基地址，然后根据vpn[2]来选择pte，首先看看是不是指向下一级页表的pte，如果R，W，X都是0则是指向下一级页表的pte，否则就是一个leaf 的pte。
+ 如果是leaf pte则检查一下当前的操作是不是可以接受，如果可以被接受，则看一下当前是第几个level，对应的只把0到这个level的ppn设置为vpn,这个level到2的ppn设置为pte的ppn，如果0到这个level的ppn不是0则发生page fault，offset直接设置即可
+ 如果是指向下一级的pte，则重新拿出ppn作为基地址，根据vpn[1]来进行选择pte，如果是最后一级则是根据vpn[0]来进行选择pte

### TLB

+ TLB的一个entry可以是一个pte的复制品，需要额外给上vpn[0],vpn[1],vpn[2]以供判断va是不是最终对应这个entry，如果是的话直接进行转换
+ 可以再加一个valid位，表示当前这个entry是不是有效的，初始全部都是无效的，TLB miss之后去PTW进行地址转化，将这个对应关系写到TLB中并设置valid位为1,之后的转化就可以直接查表进行，如果全部entry都是valid了，且发生了TLB miss则需要替换掉一个entry，可以直接采用随机替换策略，搞一个寄存器放index，随着时钟周期进行自加，加到最大后变0,每次如果要进行替换就使用这个寄存器的index进行替换即可。



